{% extends "shop/base.html" %}
{% load static %}

{% block title %}Fancy Product Store{% endblock %}

{% block content %}
<div class="row g-4">
    {% for product in product_objects %}
    <div class="col-md-4 col-lg-3">
        <div class="card product-card">
            <img src="{{ product.image }}" class="card-img-top product-img" alt="{{ product.title }}">
            <div class="card-body">
                <h5 id="nm{{product.id}}" class="card-title">{{ product.title }}</h5>
                <p class="category-badge">{{ product.category }}</p>
                <p class="mt-2">
                    <span id="fetus" class="discount-price">{{ product.price }}</span>
                    <span id="price{{product.id}}" class="d-none">{{ product.discount_price }}</span>
                    <span class="ms-2">${{ product.discount_price }}</span>
                </p>
                <p class="card-text text-muted" style="font-size:0.9rem;">
                    {{ product.description }}
                </p>
                <a class="btn btn-outline-primary" href="/{{product.id}}">view</a>
                
                {% if user.is_authenticated %}
                    <button id="{{product.id}}" class="btn atc btn-primary w-100">Add to Cart ðŸ›’</button>
                {% else %}
                    <a href="{% url 'login' %}" class="btn btn-secondary w-100">Login to Add to Cart</a>
                {% endif %}
            </div>
        </div>
    </div>
    {% empty %}
    <p class="text-center">No products available at the moment.</p>
    {% endfor %}
</div>

<!-- Pagination remains the same -->
<div class="d-flex justify-content-center mt-4">
    <nav aria-label="Page navigation">
        <ul class="pagination">
            {% if product_objects.has_previous %}
                <li class="page-item">
                    <a class="page-link" href="?{% if item_name %}item_name={{ item_name }}&{% endif %}page=1">Â« First</a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="?{% if item_name %}item_name={{ item_name }}&{% endif %}page={{ product_objects.previous_page_number }}">â€¹ Prev</a>
                </li>
            {% else %}
                <li class="page-item disabled"><span class="page-link">Â« First</span></li>
                <li class="page-item disabled"><span class="page-link">â€¹ Prev</span></li>
            {% endif %}

            {% for num in product_objects.paginator.page_range %}
                {% if product_objects.number == num %}
                    <li class="page-item active"><span class="page-link">{{ num }}</span></li>
                {% elif num > product_objects.number|add:'-3' and num < product_objects.number|add:'3' %}
                    <li class="page-item">
                        <a class="page-link" href="?{% if item_name %}item_name={{ item_name }}&{% endif %}page={{ num }}">{{ num }}</a>
                    </li>
                {% endif %}
            {% endfor %}

            {% if product_objects.has_next %}
                <li class="page-item">
                    <a class="page-link" href="?{% if item_name %}item_name={{ item_name }}&{% endif %}page={{ product_objects.next_page_number }}">Next â€º</a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="?{% if item_name %}item_name={{ item_name }}&{% endif %}page={{ product_objects.paginator.num_pages }}">Last Â»</a>
                </li>
            {% else %}
                <li class="page-item disabled"><span class="page-link">Next â€º</span></li>
                <li class="page-item disabled"><span class="page-link">Last Â»</span></li>
            {% endif %}
        </ul>
    </nav>
</div>
{% endblock %}

{% block scripts %}
{% if user.is_authenticated %}
<script type="text/javascript">
    // Initialize cart count from server
    document.getElementById("cart").innerText = {{ cart_count }};

    // Function to get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Load cart items from server
    function loadCartItems() {
        fetch('/get-cart/')
            .then(response => response.json())
            .then(data => {
                if (data.cart_items) {
                    updateCartDisplay(data.cart_items, data.total_price);
                    document.getElementById("cart").innerText = data.cart_count;
                }
            })
            .catch(error => console.error('Error loading cart:', error));
    }

    // Update cart display for popover
    function updateCartDisplay(cartItems, totalPrice) {
        window.cartItems = cartItems;
        window.totalPrice = totalPrice;
    }

    // Popover content for cart
    function getCartPopoverContent() {
        if (!window.cartItems || window.cartItems.length === 0) {
            return "Cart is empty";
        }
        
        let content = "<div class='p-2'>";
        content += "<ul class='list-group list-group-flush'>";
        
        window.cartItems.forEach(item => {
            content += `<li class="list-group-item d-flex justify-content-between px-0">
                            ${item.name}
                            <span class="badge bg-primary">${item.quantity}</span>
                        </li>`;
        });
        
        content += "</ul>";
        content += `<div class='p-2 border-top'>
                        <strong>Total: $${window.totalPrice.toFixed(2)}</strong>
                    </div>`;
        content += `<div class='p-2 border-top'>
                        <button class='btn btn-success btn-sm w-100' onclick='window.location.href="/checkout/"'>
                            Go to Checkout
                        </button>
                    </div>`;
        
        return content;
    }

    // Initialize Bootstrap popover
    var cartBtn = document.querySelector('.cart');
    var popover = new bootstrap.Popover(cartBtn, {
        html: true,
        sanitize: false,
        trigger: 'click',
        placement: 'bottom',
        content: function() {
            return getCartPopoverContent();
        }
    });

    // Load cart items on page load
    loadCartItems();

    // Add to Cart button click
    $(document).on('click', '.atc', function () {
        var productId = this.id;
        var csrfToken = getCookie('csrftoken');

        $.ajax({
            url: '/add-to-cart/',
            type: 'POST',
            data: {
                'product_id': productId,
                'csrfmiddlewaretoken': csrfToken
            },
            success: function(response) {
                if (response.success) {
                    document.getElementById("cart").innerHTML = response.cart_count;
                    loadCartItems(); // Reload cart items
                    
                    // Show success message (optional)
                    alert(response.message);
                    
                    // Force popover to update
                    if (popover) {
                        popover.hide();
                        setTimeout(() => {
                            popover.show();
                        }, 100);
                    }
                } else {
                    alert('Error adding item to cart: ' + response.message);
                }
            },
            error: function(xhr, status, error) {
                console.error('Error:', error);
                alert('Error adding item to cart');
            }
        });
    });

    // Update popover content when showing
    cartBtn.addEventListener('show.bs.popover', function () {
        loadCartItems();
    });

    // Ensure popover hides when clicking elsewhere
    document.addEventListener('click', function (e) {
        if (!cartBtn.contains(e.target)) {
            popover.hide();
        }
    });
</script>
{% endif %}
{% endblock %}